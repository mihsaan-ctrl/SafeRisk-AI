<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SiteRisk AI - Construction Disaster Analysis</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background: #000;
  color: #fff;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.header {
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
  padding: 25px 40px;
  border-bottom: 3px solid #00d9ff;
  box-shadow: 0 8px 32px rgba(0, 217, 255, 0.2);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.1), transparent);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.header h1 {
  font-size: 32px;
  font-weight: 900;
  background: linear-gradient(135deg, #00d9ff 0%, #0099ff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.header p {
  color: #aaa;
  font-size: 14px;
  margin-top: 8px;
  font-weight: 300;
  letter-spacing: 1px;
}

.container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

#map {
  flex: 1;
  height: 100%;
}

.sidebar {
  width: 420px;
  background: linear-gradient(180deg, #0a0a0a 0%, #111 100%);
  border-left: 3px solid #00d9ff;
  padding: 30px;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  gap: 25px;
  box-shadow: -10px 0 40px rgba(0, 0, 0, 0.8);
}

.sidebar::-webkit-scrollbar {
  width: 8px;
}

.sidebar::-webkit-scrollbar-track {
  background: #0a0a0a;
}

.sidebar::-webkit-scrollbar-thumb {
  background: #00d9ff;
  border-radius: 4px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: #0099ff;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.input-group label {
  font-size: 13px;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.input-group input {
  padding: 12px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
  outline: none;
  transition: all 0.3s;
}

.input-group input:focus {
  border-color: #00d9ff;
  box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
}

.btn {
  padding: 16px;
  background: linear-gradient(135deg, #00d9ff 0%, #0077ff 100%);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 2px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 24px rgba(0, 119, 255, 0.4);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
  width: 300px;
  height: 300px;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(0, 217, 255, 0.6);
}

.btn:active {
  transform: translateY(-1px);
}

.btn:disabled {
  background: #333;
  cursor: not-allowed;
  box-shadow: none;
}

.risk-panel {
  background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
  border: 2px solid #00d9ff;
  border-radius: 12px;
  padding: 25px;
  display: none;
  box-shadow: 0 0 40px rgba(0, 217, 255, 0.2);
  animation: slideIn 0.4s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.risk-panel.active {
  display: block;
}

.risk-score {
  text-align: center;
  padding: 30px;
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
  border-radius: 12px;
  margin-bottom: 25px;
  border: 2px solid;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  position: relative;
  overflow: hidden;
}

.risk-score::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 0.5; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

@keyframes pulse-marker {
  0% { transform: scale(1); box-shadow: 0 0 20px #00d9ff; }
  50% { transform: scale(1.2); box-shadow: 0 0 40px #00d9ff; }
  100% { transform: scale(1); box-shadow: 0 0 20px #00d9ff; }
}

.risk-score h2 {
  font-size: 64px;
  font-weight: 900;
  margin-bottom: 8px;
  text-shadow: 0 0 30px currentColor;
  position: relative;
  z-index: 1;
}

.risk-score.low { 
  color: #00ff88; 
  border-color: #00ff88;
  box-shadow: 0 8px 32px rgba(0, 255, 136, 0.3);
}
.risk-score.medium { 
  color: #ffaa00; 
  border-color: #ffaa00;
  box-shadow: 0 8px 32px rgba(255, 170, 0, 0.3);
}
.risk-score.high { 
  color: #ff4444; 
  border-color: #ff4444;
  box-shadow: 0 8px 32px rgba(255, 68, 68, 0.3);
}

.risk-score p {
  color: #888;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 3px;
  font-weight: 600;
  position: relative;
  z-index: 1;
}

.hazard-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 20px 0;
}

.hazard-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 16px;
  background: linear-gradient(135deg, #0a0a0a 0%, #111 100%);
  border-left: 4px solid;
  border-radius: 8px;
  transition: all 0.3s;
  cursor: pointer;
}

.hazard-item:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

.hazard-item.flood { 
  border-color: #0099ff;
  box-shadow: 0 0 20px rgba(0, 153, 255, 0.2);
}
.hazard-item.earthquake { 
  border-color: #ff9900;
  box-shadow: 0 0 20px rgba(255, 153, 0, 0.2);
}
.hazard-item.fire { 
  border-color: #ff4444;
  box-shadow: 0 0 20px rgba(255, 68, 68, 0.2);
}

.hazard-icon {
  font-size: 32px;
  filter: drop-shadow(0 0 8px currentColor);
}

.hazard-info h4 {
  font-size: 14px;
  margin-bottom: 4px;
}

.hazard-info p {
  font-size: 12px;
  color: #888;
}

.ai-analysis {
  background: linear-gradient(135deg, #0a0a0a 0%, #0f0f0f 100%);
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #00d9ff;
  margin-top: 20px;
  box-shadow: 0 0 30px rgba(0, 217, 255, 0.2);
}

.ai-analysis h3 {
  font-size: 16px;
  color: #00d9ff;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  letter-spacing: 1px;
}

.ai-analysis p {
  font-size: 14px;
  line-height: 1.8;
  color: #ddd;
  font-weight: 300;
}

.loading {
  text-align: center;
  padding: 30px;
  color: #888;
}

.spinner {
  border: 3px solid #333;
  border-top: 3px solid #00d9ff;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .container { flex-direction: column; }
  .sidebar { width: 100%; max-height: 50vh; }
}
</style>
</head>
<body>

<div class="header">
  <h1>‚ö° SITERISK PRO</h1>
  <p>AI-Powered Disaster Intelligence for Construction Sites</p>
</div>

<div class="container">
  <div id="map"></div>
  
  <div class="sidebar">
    <div class="input-group">
      <label>üéØ Project Site Address</label>
      <input type="text" id="addressInput" placeholder="e.g., 123 Market St, San Francisco, CA">
    </div>
    
    <button class="btn" id="analyzeBtn">üîç Analyze Risk Profile</button>
    
    <div class="risk-panel" id="riskPanel">
      <div class="risk-score" id="riskScore">
        <h2 id="scoreValue">--</h2>
        <p>Risk Score</p>
      </div>
      
      <div class="hazard-list" id="hazardList"></div>
      
      <div class="ai-analysis">
        <h3>üß† AI ANALYSIS</h3>
        <p id="aiAnalysis">Analyzing site conditions...</p>
      </div>
    </div>
    
    <div class="loading" id="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Analyzing disaster risk data...</p>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', {
  zoomControl: true,
  attributionControl: false
}).setView([34.0522, -118.2437], 10);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
  maxZoom: 19,
  minZoom: 3
}).addTo(map);

let currentMarker = null;
let riskLayers = [];

document.getElementById('analyzeBtn').addEventListener('click', analyzeSite);

async function analyzeSite() {
  const address = document.getElementById('addressInput').value.trim();
  if (!address) {
    alert('Please enter an address');
    return;
  }
  
  document.getElementById('loading').style.display = 'block';
  document.getElementById('riskPanel').classList.remove('active');
  
  // Geocode address
  const coords = await geocodeAddress(address);
  if (!coords) {
    alert('Could not find that address');
    document.getElementById('loading').style.display = 'none';
    return;
  }
  
  // Update map
  if (currentMarker) map.removeLayer(currentMarker);
  
  const pulsingIcon = L.divIcon({
    className: 'pulsing-marker',
    html: '<div style="width: 20px; height: 20px; background: #00d9ff; border-radius: 50%; box-shadow: 0 0 20px #00d9ff; animation: pulse-marker 2s infinite;"></div>',
    iconSize: [20, 20]
  });
  
  currentMarker = L.marker([coords.lat, coords.lon], { icon: pulsingIcon }).addTo(map)
    .bindPopup(`<b>üìç Analysis Site</b><br>${address}`).openPopup();
  map.setView([coords.lat, coords.lon], 13);
  
  // Fetch real disaster data
  const risks = await fetchRiskData(coords.lat, coords.lon);
  
  // Get AI analysis
  const aiAnalysis = await getAIAnalysis(address, risks);
  
  // Display results
  displayResults(risks, aiAnalysis);
}

async function geocodeAddress(address) {
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.length > 0) {
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }
  } catch (e) {
    console.error('Geocoding error:', e);
  }
  return null;
}

async function fetchRiskData(lat, lon) {
  const risks = {
    earthquake: { level: 0, distance: null },
    flood: { level: 0, zone: null },
    fire: { level: 0, recent: false }
  };
  
  // Fetch USGS earthquake data
  try {
    const eqUrl = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson';
    const eqRes = await fetch(eqUrl);
    const eqData = await eqRes.json();
    
    let minDist = Infinity;
    let closestMag = 0;
    
    eqData.features.forEach(eq => {
      const [lng, eqLat] = eq.geometry.coordinates;
      const dist = getDistance(lat, lon, eqLat, lng);
      if (dist < minDist) {
        minDist = dist;
        closestMag = eq.properties.mag || 0;
      }
    });
    
    if (minDist < 100) {
      risks.earthquake.level = Math.min(10, Math.round((closestMag * 10) / (minDist / 10)));
      risks.earthquake.distance = minDist;
      
      // Draw earthquake zones on map
      clearRiskLayers();
      eqData.features.slice(0, 10).forEach(eq => {
        const [lng, eqLat] = eq.geometry.coordinates;
        const mag = eq.properties.mag || 1;
        const circle = L.circle([eqLat, lng], {
          radius: mag * 15000,
          color: '#ff9900',
          fillColor: '#ff9900',
          fillOpacity: 0.3,
          weight: 2
        }).addTo(map).bindPopup(`<b>Magnitude ${mag.toFixed(1)}</b><br>${eq.properties.place}`);
        riskLayers.push(circle);
      });
    }
  } catch (e) {
    console.error('Earthquake data error:', e);
  }
  
  // Simulate flood/fire risk based on location (demo purposes)
  const floodProne = Math.random() * 10;
  const fireProne = Math.random() * 10;
  
  risks.flood.level = Math.round(floodProne);
  risks.fire.level = Math.round(fireProne);
  
  return risks;
}

async function getAIAnalysis(address, risks) {
  const riskSummary = `
Address: ${address}
Earthquake Risk: ${risks.earthquake.level}/10 (${risks.earthquake.distance ? risks.earthquake.distance.toFixed(1) + ' km from recent activity' : 'no recent activity'})
Flood Risk: ${risks.flood.level}/10
Fire Risk: ${risks.fire.level}/10
  `.trim();
  
  try {
    const response = await fetch('https://broken-dust-1210.mihsaan.workers.dev/', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        messages: [{
          role: 'user',
          content: `You are a senior construction risk analyst with 15+ years of experience. Analyze this construction site for natural disaster vulnerabilities.

SITE DATA:
${riskSummary}

Provide a professional risk assessment in 3-4 sentences covering:
1. Primary concerns for construction
2. Specific structural recommendations
3. Insurance/permit considerations

Be direct, technical, and actionable. Do not mention AI or analysis services.`
        }]
      })
    });
    
    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.content && data.content[0] && data.content[0].text) {
      return data.content[0].text;
    } else {
      throw new Error('Invalid API response');
    }
  } catch (e) {
    console.error('AI Analysis Error:', e);
    
    // Fallback: Generate smart analysis based on risk data
    let analysis = '';
    const totalRisk = risks.earthquake.level + risks.flood.level + risks.fire.level;
    
    if (totalRisk > 18) {
      analysis = 'This site presents significant multi-hazard concerns. ';
    } else if (totalRisk > 12) {
      analysis = 'Moderate risk factors identified requiring mitigation strategies. ';
    } else {
      analysis = 'Site shows acceptable risk levels with standard precautions. ';
    }
    
    if (risks.earthquake.level > 5) {
      analysis += `Seismic activity within ${risks.earthquake.distance?.toFixed(0) || 'nearby'} km requires enhanced foundation design per IBC seismic standards. `;
    }
    
    if (risks.flood.level > 5) {
      analysis += 'Elevated flood risk mandates FEMA compliance review and potential elevation requirements. ';
    }
    
    if (risks.fire.level > 5) {
      analysis += 'Wildfire exposure necessitates fire-resistant materials and defensible space planning. ';
    }
    
    analysis += 'Recommend comprehensive geotechnical survey and consultation with licensed structural engineer before permit submission.';
    
    return analysis;
  }
}

function displayResults(risks, aiText) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('riskPanel').classList.add('active');
  
  // Calculate overall risk score
  const totalRisk = risks.earthquake.level + risks.flood.level + risks.fire.level;
  const avgRisk = Math.round(totalRisk / 3);
  
  const scoreEl = document.getElementById('riskScore');
  const scoreValue = document.getElementById('scoreValue');
  scoreValue.textContent = avgRisk;
  
  scoreEl.classList.remove('low', 'medium', 'high');
  if (avgRisk <= 3) scoreEl.classList.add('low');
  else if (avgRisk <= 6) scoreEl.classList.add('medium');
  else scoreEl.classList.add('high');
  
  // Display hazards
  const hazardList = document.getElementById('hazardList');
  hazardList.innerHTML = '';
  
  if (risks.earthquake.level > 0) {
    hazardList.innerHTML += `
      <div class="hazard-item earthquake">
        <div class="hazard-icon">üåã</div>
        <div class="hazard-info">
          <h4>Earthquake Zone</h4>
          <p>Risk Level: ${risks.earthquake.level}/10 ${risks.earthquake.distance ? `(${risks.earthquake.distance.toFixed(1)} km from activity)` : ''}</p>
        </div>
      </div>
    `;
  }
  
  if (risks.flood.level > 0) {
    hazardList.innerHTML += `
      <div class="hazard-item flood">
        <div class="hazard-icon">üåä</div>
        <div class="hazard-info">
          <h4>Flood Risk</h4>
          <p>Risk Level: ${risks.flood.level}/10</p>
        </div>
      </div>
    `;
  }
  
  if (risks.fire.level > 0) {
    hazardList.innerHTML += `
      <div class="hazard-item fire">
        <div class="hazard-icon">üî•</div>
        <div class="hazard-info">
          <h4>Wildfire Risk</h4>
          <p>Risk Level: ${risks.fire.level}/10</p>
        </div>
      </div>
    `;
  }
  
  // Clean up markdown formatting from AI response
  const cleanText = aiText.replace(/\*\*(.*?)\*\*/g, '$1');
  document.getElementById('aiAnalysis').textContent = cleanText;
}

function clearRiskLayers() {
  riskLayers.forEach(layer => map.removeLayer(layer));
  riskLayers = [];
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>

</body>
</html>